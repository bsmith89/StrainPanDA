# Generate customize pangenome database for StrainPanDA

## Generate the pangenome

### Step1: get the information of all targeted strains

You can download the strain information of target species from Genome List in NCBI

For example, for *E. coli*, you can get from [Genome List - Genome - NCBI (nih.gov)](https://www.ncbi.nlm.nih.gov/genome/browse#!/prokaryotes/Escherichia coli)

### Step2:

Within the SimStr docker (see [SimStr](https://github.com/xbiome/StrainPanDA/blob/main/SimStr/README.md), select the representative strains and generate the pangenome as the example:

```
fileout=Bifidobacterium-longum-202009
sh /script/Ref_str_select_ANI_mash.sh Bifidobacterium-longum-20200915.csv $fileout /script/ 99
```

Here，

Bifidobacterium-longum-20200915.csv is the strain file of *B. longum* from Step1; 

Bifidobacterium-longum-202009 is the name of the pangenome database, it must be in the following format: genus-species-yearmonth(in number) ;

99 is the max of pairwise ANI allowed among representative genomes, genomes with ANI bigger than this value will be clustered. Change this value might affect StrainPanDA's performance.

/script/ is the path of SimStr and should be setup by the docker run already.

If docker is not available, user can use singularity in a similar way instead of docker.

### Outputs:

Only the $fileout folder (Bifidobacterium-longum-202009 in the example) is the pangenome. Its format is same as PanPhlAn (see [Pangenome generation (old) · SegataLab/panphlan Wiki (github.com)](https://github.com/SegataLab/panphlan/wiki/Pangenome-generation-(old)))

All other files are intermediate files that should be removed before next pangenome generation in the same folder.

> **Note**
> 1. Each generation must run in separated folder, otherwise the references data will disturb each other.
> 2. If the panphlan failed with error message like "zlib.error: Error -3 while decompressing: invalid block type", it is caused by the fail of download by wget in the strain-pan folder. In this case, users need to replace them by correct files manually. Users can check the fail of files by `check_gz_integrity.sh`, and use the `broken_ID.txt` to extract the subset of download list (For example, `cd strain-pan;grep -f broken_ID.txt $fileout"_ref_dl_list.txt_sel.txt" > broken_ref_dl_list.txt; wget -c -i broken_ref_dl_list.txt`). Sometimes the broken file is caused by `wget -c`, so you can use wget to download again into the strain-pan folder: `cd strain-pan;grep -f broken_ID.txt $fileout"_ref_dl_list.txt_sel.txt" > broken_ref_dl_list.txt; wget -i broken_ref_dl_list.txt`.
> 3. If the panphlan failed, need to delete all the panphlan related output and rerun the pipeline (generally, this is caused by the disconnection of download, or users could download first and run panphlan separately), or panphlan will crash again because of the existing files.  Lastly, run panphlan by the following command: `panphlan_pangenome_generation.py -c $fileout --i_fna strain-pan/ --i_gff strain-pan/ -o $fileout`. In the example, file_out is `Bifidobacterium-longum-202009`
> 4. The `.csv` file from step1 should be the newest one, or the download link of some strains might be expired and failed

## Annotate the pangenome

All the annotations should be run within the SimStr docker (see [SimStr](https://github.com/xbiome/StrainPanDA/blob/main/SimStr/README.md))



### CAZy annotation

```
python /script/cazy_anno.py -i . -o cazy -d path_to_CAZy_DB
```

-i the input folder, can be the current folder or the $fileout of the target pangenome.

-d path_to_CAZy_DB points to the CAZy (dbCAN2) database. which can be downloaded by: (see [Index of /dbCAN2/download (unl.edu)](https://bcb.unl.edu/dbCAN2/download/) for updates and instructions)

```
wget http://bcb.unl.edu/dbCAN2/download/CAZyDB.07312019.fa.nr && diamond makedb --in CAZyDB.07312019.fa.nr -d CAZy \
    && wget http://bcb.unl.edu/dbCAN2/download/Databases/dbCAN-HMMdb-V8.txt && mv dbCAN-HMMdb-V8.txt dbCAN.txt && hmmpress dbCAN.txt \
    && wget http://bcb.unl.edu/dbCAN2/download/Databases/tcdb.fa && diamond makedb --in tcdb.fa -d tcdb \
    && wget http://bcb.unl.edu/dbCAN2/download/Databases/tf-1.hmm && hmmpress tf-1.hmm \
    && wget http://bcb.unl.edu/dbCAN2/download/Databases/tf-2.hmm && hmmpress tf-2.hmm \
    && wget http://bcb.unl.edu/dbCAN2/download/Databases/stp.hmm && hmmpress stp.hmm 
```

#### Output

The final output is in the cazy/cazy folder. One file per pangenome. In each file, the first column is the gene family ID, the second column is the CAZy catalog ID.



### VFDB annotation

```
python /script/vfdb_anno.py -i . -o vfdb_out -db $path_to_VFDB -pi 50 -cov 50
```

-i the input folder, can be the current folder or the $fileout of the target pangenome.

-d $path_to_VFDB points to the VFDB diamond database which can be generated by:

```
diamond makedb --in VFDB_setA_pro.fas -d $path_to_VFDB
```

The VFDB_setA_pro.fas was downloaded from [VFDB: Virulence Factors of Bacterial Pathogens (mgc.ac.cn)](http://www.mgc.ac.cn/cgi-bin/VFs/v5/main.cgi) in the download page as the protein sequences of core dataset. (Current version was downloaded on 2021_04_13)

$path_to_VFDB can be any user defined path.

-pi and -cov used to set the cutoff of blast identity and coverage percentage. 

#### Output

The final output is in the vfdb_out/final_out folder. One file per pangenome. In each file, the first column is the gene family ID, the second column is the VFDB ID.

### EggNOG mapper annotation

Functions including KEGG KO mapping(s) can be annotated with the [EggNOG mapper](http://eggnog-mapper.embl.de/).

```
for i in ${pangenome_db_path}/*/*.ffn; do bs=`basename $i`;emapper.py -i $i --itype CDS --cpu 16 -o ${bs%%.ffn};done
for i in  ${pangenome_db_path}/* ; do bs=`basename $i` ;  cp panphlan_${bs}_centroids.emapper.annotations $i/${bs}_emapper_anno.tsv;done
```

#### Output

The final output will be copied to the specific species pangenome folder. The columns of the annotation file are given in the header of the `{species_version}_emapper_anno.tsv` file. For example:

```
#query	seed_ortholog	evalue	score	eggNOG_OGs	max_annot_lvl	COG_category	Description	Preferred_name	GOs	EC	KEGG_ko	KEGG_Pathway	KEGG_Module	KEGG_Reaction	KEGG_rclass	BRITE	KEGG_TC	CAZy	BiGG_Reaction	PFAMs
```

